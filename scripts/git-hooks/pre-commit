#!/bin/bash

# ============================================
# HEARST CONTROL - GIT HOOK PRE-COMMIT
# VÃ©rifie synchronisation avant commit
# ============================================

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo ""
echo -e "${CYAN}ğŸ” Hearst Control - VÃ©rification pre-commit${NC}"
echo ""

# Trouver le root du repo
GIT_ROOT=$(git rev-parse --show-toplevel)

# ============================================
# 1. VÃ‰RIFIER LES SECRETS
# ============================================

echo -e "${CYAN}ğŸ” VÃ©rification des secrets...${NC}"

# Patterns de secrets Ã  dÃ©tecter
SECRET_PATTERNS=(
    "SUPABASE_URL=http"
    "SUPABASE_KEY=[a-zA-Z0-9]"
    "JWT_SECRET=[a-zA-Z0-9]"
    "password.*=.*[^example]"
    "api_key"
    "API_KEY"
    "secret_key"
    "private_key"
)

SECRETS_FOUND=0

for pattern in "${SECRET_PATTERNS[@]}"; do
    if git diff --cached --diff-filter=AM | grep -iE "$pattern" > /dev/null; then
        if [ $SECRETS_FOUND -eq 0 ]; then
            echo ""
            echo -e "${RED}âŒ SECRETS DÃ‰TECTÃ‰S DANS LE COMMIT${NC}"
            echo ""
        fi
        echo -e "   ${RED}â€¢${NC} Pattern trouvÃ©: $pattern"
        SECRETS_FOUND=$((SECRETS_FOUND + 1))
    fi
done

if [ $SECRETS_FOUND -gt 0 ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘                                                    â•‘${NC}"
    echo -e "${RED}â•‘     â›” COMMIT BLOQUÃ‰ - SECRETS DÃ‰TECTÃ‰S â›”        â•‘${NC}"
    echo -e "${RED}â•‘                                                    â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Actions:${NC}"
    echo "1. Retirez les secrets des fichiers"
    echo "2. Utilisez des variables d'environnement (.env)"
    echo "3. Ajoutez .env au .gitignore"
    echo ""
    echo "Voir: GUIDE_ROTATION_SECRETS.md"
    echo ""
    exit 1
else
    echo -e "${GREEN}   âœ“ Aucun secret dÃ©tectÃ©${NC}"
fi

# ============================================
# 2. DÃ‰TECTER CHANGEMENTS CRITIQUES
# ============================================

echo ""
echo -e "${CYAN}ğŸ” DÃ©tection des changements critiques...${NC}"

# Fichiers staged
STAGED_FILES=$(git diff --cached --name-only)

CRITICAL_FILES=()
CORE_MODIFIED=false
AUTH_MODIFIED=false
SCHEMA_MODIFIED=false

while IFS= read -r file; do
    case "$file" in
        core/auth/*)
            CRITICAL_FILES+=("$file")
            CORE_MODIFIED=true
            AUTH_MODIFIED=true
            ;;
        core/middleware/*)
            CRITICAL_FILES+=("$file")
            CORE_MODIFIED=true
            ;;
        core/database/*)
            CRITICAL_FILES+=("$file")
            CORE_MODIFIED=true
            ;;
        core/*)
            CRITICAL_FILES+=("$file")
            CORE_MODIFIED=true
            ;;
        backend-central/routes/auth.js|backend-central/controllers/authController.js)
            CRITICAL_FILES+=("$file")
            AUTH_MODIFIED=true
            ;;
        database/central-schema.sql)
            CRITICAL_FILES+=("$file")
            SCHEMA_MODIFIED=true
            ;;
    esac
done <<< "$STAGED_FILES"

if [ ${#CRITICAL_FILES[@]} -eq 0 ]; then
    echo -e "${GREEN}   âœ“ Aucun fichier critique modifiÃ©${NC}"
    echo ""
    echo -e "${GREEN}âœ… VÃ©rifications passÃ©es - Commit autorisÃ©${NC}"
    echo ""
    exit 0
fi

# ============================================
# 3. AFFICHER FICHIERS CRITIQUES
# ============================================

echo ""
echo -e "${YELLOW}âš ï¸  Fichiers critiques modifiÃ©s:${NC}"
for file in "${CRITICAL_FILES[@]}"; do
    echo -e "   ${RED}â€¢${NC} $file"
done

# ============================================
# 4. VÃ‰RIFIER SI SYNCHRONISATION EFFECTUÃ‰E
# ============================================

echo ""
echo -e "${CYAN}ğŸ”„ VÃ©rification de la synchronisation...${NC}"

SYNC_NEEDED=false
SYNC_ERRORS=()

if [ "$CORE_MODIFIED" = true ]; then
    echo ""
    echo -e "${YELLOW}   Core modifiÃ© - VÃ©rification des projets...${NC}"
    
    # VÃ©rifier que les projets ont les mÃªmes fichiers
    PROJECTS=("hearst-design" "hearst-qatar-new" "hearst-strategic-reserve-qatar")
    
    for file in "${CRITICAL_FILES[@]}"; do
        if [[ "$file" == core/* ]]; then
            # Extraire le nom du fichier core
            CORE_FILE="${file#core/}"
            
            for project in "${PROJECTS[@]}"; do
                # Chemin attendu dans le projet
                PROJECT_FILE="projects/$project/backend/core-modules/$CORE_FILE"
                
                # VÃ©rifier si le fichier existe dans le projet
                if [ ! -f "$GIT_ROOT/$PROJECT_FILE" ]; then
                    SYNC_ERRORS+=("$PROJECT_FILE manquant")
                    SYNC_NEEDED=true
                else
                    # Comparer les fichiers
                    if ! cmp -s "$GIT_ROOT/$file" "$GIT_ROOT/$PROJECT_FILE"; then
                        SYNC_ERRORS+=("$PROJECT_FILE non synchronisÃ© avec $file")
                        SYNC_NEEDED=true
                    fi
                fi
            done
        fi
    done
fi

# ============================================
# 5. DÃ‰CISION FINALE
# ============================================

if [ "$SYNC_NEEDED" = true ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘                                                    â•‘${NC}"
    echo -e "${RED}â•‘    â›” COMMIT BLOQUÃ‰ - SYNCHRONISATION REQUISE â›”   â•‘${NC}"
    echo -e "${RED}â•‘                                                    â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}ProblÃ¨mes dÃ©tectÃ©s:${NC}"
    for error in "${SYNC_ERRORS[@]}"; do
        echo -e "   ${RED}â€¢${NC} $error"
    done
    echo ""
    echo -e "${CYAN}ACTIONS REQUISES:${NC}"
    echo ""
    echo "1. Synchroniser les fichiers core vers les projets:"
    echo -e "   ${GREEN}./scripts/sync-core-to-projects.sh${NC}"
    echo ""
    echo "2. Ajouter les fichiers synchronisÃ©s au commit:"
    echo -e "   ${GREEN}git add projects/*/backend/core-modules/${NC}"
    echo ""
    echo "3. Recommiter:"
    echo -e "   ${GREEN}git commit -m \"sync: Propagation core â†’ projects\"${NC}"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Pour bypasser (DÃ‰CONSEILLÃ‰):${NC}"
    echo "   git commit --no-verify"
    echo ""
    exit 1
fi

# ============================================
# 6. AVERTISSEMENTS FINAUX
# ============================================

if [ "$AUTH_MODIFIED" = true ]; then
    echo ""
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘                                                    â•‘${NC}"
    echo -e "${YELLOW}â•‘      âš ï¸  MODIFICATION D'AUTHENTIFICATION âš ï¸       â•‘${NC}"
    echo -e "${YELLOW}â•‘                                                    â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}AprÃ¨s le commit, OBLIGATOIRE:${NC}"
    echo "1. Tester l'authentification sur TOUS les projets"
    echo "2. VÃ©rifier les logs de sÃ©curitÃ©"
    echo "3. Tester les diffÃ©rents rÃ´les (admin, manager, operator)"
    echo ""
fi

if [ "$SCHEMA_MODIFIED" = true ]; then
    echo ""
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘                                                    â•‘${NC}"
    echo -e "${YELLOW}â•‘         âš ï¸  MODIFICATION DE SCHÃ‰MA DB âš ï¸          â•‘${NC}"
    echo -e "${YELLOW}â•‘                                                    â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}AprÃ¨s le commit, OBLIGATOIRE:${NC}"
    echo "1. CrÃ©er et tester les migrations"
    echo "2. Mettre Ã  jour les schÃ©mas des projets"
    echo "3. VÃ©rifier l'intÃ©gritÃ© des donnÃ©es"
    echo ""
fi

# ============================================
# SUCCESS
# ============================================

echo ""
echo -e "${GREEN}âœ… Toutes les vÃ©rifications passÃ©es${NC}"
echo ""
echo -e "${CYAN}ğŸ“ N'oubliez pas aprÃ¨s le commit:${NC}"
echo "   â€¢ Tester les projets: ./scripts/test-multi-tenant.sh"
echo "   â€¢ Mettre Ã  jour VERSION.json si nÃ©cessaire"
echo "   â€¢ Documenter les changements dans CHANGELOG.md"
echo ""

exit 0

