# Hearst Control V2.0 - RÃ¨gles pour Agents AI

## ğŸ¯ CONTEXTE DU PROJET

Hearst Control est une **application Electron (de bureau)** pour gÃ©rer plusieurs **projets web indÃ©pendants** pour Hearst avec une architecture multi-tenant.

### Nature de l'Application

**Hearst Control** = Application de bureau (Electron) qui :
- âœ… GÃ¨re plusieurs projets web depuis une interface centralisÃ©e
- âœ… Fournit une authentification multi-tenant
- âœ… Orchestre les projets via un backend central (API Gateway)
- âœ… Isole complÃ¨tement chaque projet web

**Projets actuels** (tous des projets web) :
- **Hearst Qatar** : Projet web
- **Hearst SRQ** (Strategic Reserve Qatar) : Projet web
- **Hearst Design** : Projet web en dÃ©veloppement

### Architecture en 30 Secondes

```
HEARST CONTROL (Plateforme Centrale)
â”œâ”€â”€ core/                  â† Code commun rÃ©utilisable (70-80%)
â”œâ”€â”€ backend-central/       â† API Gateway + Auth (Port 4000)
â”œâ”€â”€ projects/              â† Projets isolÃ©s
â”‚   â”œâ”€â”€ hearst-design/         (Port 3002)
â”‚   â”œâ”€â”€ hearst-qatar-new/      (Port 3001)
â”‚   â””â”€â”€ hearst-strategic-reserve-qatar/ (Port 3003)
â””â”€â”€ scripts/               â† Automatisation
```

---

## ğŸ“š LECTURE OBLIGATOIRE

AVANT toute intervention, lire dans cet ordre :

1. `QUICK_START_AI.md` (2 min) - Vue d'ensemble rapide
2. `AI_AGENT_GUIDE.md` (10 min) - Guide complet
3. `docs/ESSENTIELS/RULES_REFERENCE.md` (10 min) - 41 rÃ¨gles dÃ©taillÃ©es
4. `PROJECT_STRUCTURE.md` (5 min) - Structure annotÃ©e

---

## âš ï¸ LES 41 RÃˆGLES FONDAMENTALES

### ğŸ—ï¸ Architecture (RÃ¨gles 1-3)

**#1** La plateforme centrale ne contient JAMAIS de code mÃ©tier spÃ©cifique Ã  un projet
**#2** Chaque projet est totalement isolÃ© et indÃ©pendant
**#3** Le code commun rÃ©utilisable va dans `core/`

### ğŸ’¾ Base de DonnÃ©es (RÃ¨gles 4-6)

**#4** Un utilisateur ne voit JAMAIS les donnÃ©es d'un autre tenant
**#5** Seul le `super_admin` peut voir tous les tenants
**#6** Les requÃªtes SQL doivent TOUJOURS filtrer par `tenant_id` (sauf super_admin)

### ğŸ” Authentification (RÃ¨gles 7-10)

**#7** Pas de tenant_id dans le JWT = pas d'accÃ¨s
**#8** Le token doit Ãªtre vÃ©rifiÃ© sur CHAQUE requÃªte protÃ©gÃ©e
**#9** Un rÃ´le infÃ©rieur ne peut JAMAIS effectuer d'actions d'un rÃ´le supÃ©rieur
**#10** Permissions vÃ©rifiÃ©es au niveau middleware ET contrÃ´leur

### ğŸ”„ RÃ©utilisabilitÃ© (RÃ¨gles 11-15)

**#11** NE JAMAIS rÃ©Ã©crire l'authentification - utiliser core/auth/
**#12** NE JAMAIS recrÃ©er la structure de projet
**#13** TOUJOURS utiliser le script `deploy-project.sh` pour crÃ©er un projet
**#14** Nouveau projet = 3-6 semaines MAX (au lieu de 8-12)
**#15** Ã‰conomie de 50-60% de temps MINIMUM

### ğŸ“Š CrÃ©ation Projet (RÃ¨gles 16-17)

**#16** Chaque nouveau projet DOIT avoir son propre Supabase
**#17** Isolation complÃ¨te des donnÃ©es entre projets

### ğŸ–¥ï¸ Backend Central (RÃ¨gles 18-22)

**#18** UN SEUL point d'entrÃ©e pour l'authentification
**#19** TOUS les projets passent par le backend central
**#20** JAMAIS de logique mÃ©tier dans les routes
**#21** TOUJOURS valider les inputs
**#22** TOUJOURS gÃ©rer les erreurs avec try/catch

### ğŸ“ Documentation (RÃ¨gles 23-24)

**#23** Documentation gÃ©nÃ©rÃ©e AUTOMATIQUEMENT lors de la crÃ©ation projet
**#24** Documentation mise Ã  jour Ã  CHAQUE changement majeur

### ğŸ”§ Scripts (RÃ¨gles 25-27)

**#25** Les scripts DOIVENT Ãªtre idempotents (rÃ©exÃ©cutables)
**#26** TOUJOURS vÃ©rifier les prÃ©requis avant exÃ©cution
**#27** TOUJOURS afficher des messages clairs (succÃ¨s/erreur)

### ğŸ§ª Tests (RÃ¨gles 28-29)

**#28** Les tests DOIVENT passer avant chaque commit
**#29** CI/CD DOIT bloquer si tests Ã©chouent

### ğŸš€ DÃ©ploiement (RÃ¨gles 30-31)

**#30** JAMAIS de secrets en dur dans le code
**#31** TOUJOURS utiliser des variables d'environnement

### ğŸ“ˆ Performance (RÃ¨gles 32-35)

**#32** Chaque projet DOIT Ãªtre scalable horizontalement
**#33** Base de donnÃ©es DOIT avoir des indexes sur `tenant_id`
**#34** API Gateway DOIT supporter le load balancing
**#35** Caching DOIT Ãªtre implÃ©mentÃ© pour les donnÃ©es frÃ©quentes

### ğŸ”’ SÃ©curitÃ© (RÃ¨gles 36-41)

**#36** Mots de passe DOIVENT Ãªtre hashÃ©s avec bcrypt (min 10 rounds)
**#37** Tokens JWT DOIVENT expirer (24h max)
**#38** CORS DOIT Ãªtre configurÃ© strictement
**#39** Rate limiting DOIT Ãªtre activÃ©
**#40** HTTPS OBLIGATOIRE en production
**#41** Audit logs DOIVENT tracer toutes actions sensibles

### ğŸŒ Configuration Frontend (RÃ¨gles 42-44)

**#42** Les frontends DOIVENT TOUJOURS pointer vers le Backend Central (port 4000)
**#43** AccÃ¨s direct aux backends de projet (ports 3001, 3002, 3003) INTERDIT
**#44** Modification des URLs API nÃ©cessite autorisation architecte systÃ¨me

#### RÃ¨gle #42 - Backend Central Obligatoire

```bash
# âœ… CORRECT
NEXT_PUBLIC_API_URL=http://localhost:4000/api/qatar
NEXT_PUBLIC_API_URL=http://localhost:4000/api/design
NEXT_PUBLIC_API_URL=http://localhost:4000/api/srq

# âŒ INTERDIT
NEXT_PUBLIC_API_URL=http://localhost:3001  # AccÃ¨s direct Qatar
NEXT_PUBLIC_API_URL=http://localhost:3002  # AccÃ¨s direct Design
NEXT_PUBLIC_API_URL=http://localhost:3003  # AccÃ¨s direct SRQ
```

**Voir documentation complÃ¨te** : `/REGLE_URLS_FRONTENDS.md`

---

## ğŸš« INTERDICTIONS ABSOLUES

1. âŒ JAMAIS rÃ©Ã©crire l'authentification (utiliser core/auth/)
2. âŒ JAMAIS modifier core/ sans vÃ©rifier l'impact sur TOUS les projets
3. âŒ JAMAIS crÃ©er de dÃ©pendances entre projets
4. âŒ JAMAIS mettre de secrets en dur dans le code
5. âŒ JAMAIS bypasser l'isolation tenant
6. âŒ JAMAIS importer depuis un autre projet
7. âŒ JAMAIS mettre de logique mÃ©tier dans backend-central
8. âŒ JAMAIS pousser sur main sans PR et review

---

## âœ… STANDARDS DE CODE

### JavaScript/TypeScript

- ESLint + Prettier obligatoires
- TypeScript strict mode pour frontend
- Async/await (pas de callbacks)
- try/catch sur toutes les opÃ©rations async

### Nommage

- **Fichiers** : camelCase (authController.js)
- **Classes** : PascalCase (AuthService)
- **Fonctions** : camelCase (getUserById)
- **Constantes** : UPPER_SNAKE_CASE (JWT_SECRET)
- **Dossiers** : kebab-case (shared-utils)

### Structure Fonction

```javascript
/**
 * Description de la fonction
 * @param {string} param - Description
 * @returns {Promise<Object>} Description
 */
exports.functionName = async (param) => {
  try {
    // Validation inputs
    if (!param) {
      throw new Error('Parameter required');
    }
    
    // Logique
    const result = await operation();
    
    // Retour
    return result;
  } catch (error) {
    // Gestion erreur
    throw error;
  }
};
```

---

## ğŸ”§ COMMANDES ESSENTIELLES

```bash
# Orchestration
./scripts/start-all.sh         # DÃ©marrer tous les services
./scripts/stop-all.sh          # ArrÃªter tous les services

# CrÃ©ation
./scripts/deploy-project.sh <nom>  # CrÃ©er nouveau projet

# Tests
./scripts/test-multi-tenant.sh     # Tester isolation

# SÃ©curitÃ©
./scripts/check-secrets.sh         # VÃ©rifier secrets exposÃ©s

# Backend
cd backend-central && npm start    # DÃ©marrer backend central
node test-supabase-connection.js   # Tester connexion DB
```

---

## ğŸ“‹ CHECKLIST AVANT MODIFICATION

### VÃ©rifications PrÃ©alables

- [ ] J'ai lu AI_AGENT_GUIDE.md et QUICK_START_AI.md
- [ ] Je connais le contexte (quel projet ? quel composant ?)
- [ ] J'ai vÃ©rifiÃ© les rÃ¨gles applicables
- [ ] Je ne touche pas aux autres projets
- [ ] Mes modifications respectent l'isolation

### Pendant le DÃ©veloppement

- [ ] Pas de code mÃ©tier dans core/
- [ ] Pas de code mÃ©tier dans backend-central/
- [ ] Filtrage tenant_id prÃ©sent (si applicable)
- [ ] Validation des inputs
- [ ] Gestion des erreurs (try/catch)
- [ ] Pas de secrets en dur

### AprÃ¨s Modification

- [ ] Tests passent
- [ ] Documentation mise Ã  jour
- [ ] Pas de rÃ©gression sur autres projets

---

## ğŸ¯ WORKFLOW RECOMMANDÃ‰

### Pour une Modification Simple

```
1. Lire documentation pertinente
2. Identifier le fichier Ã  modifier
3. VÃ©rifier les rÃ¨gles applicables
4. Proposer la modification
5. Attendre validation utilisateur
6. ImplÃ©menter
7. Tester
```

### Pour une Nouvelle FonctionnalitÃ©

```
1. Lire AI_AGENT_GUIDE.md complet
2. Analyser l'architecture actuelle
3. Identifier l'emplacement appropriÃ©
4. Proposer un plan dÃ©taillÃ©
5. Attendre validation
6. ImplÃ©menter par Ã©tapes
7. Tests Ã  chaque Ã©tape
8. Documentation finale
```

### Pour un Nouveau Projet

```
1. Utiliser ./scripts/deploy-project.sh
2. Configurer Supabase dÃ©diÃ©
3. Adapter schÃ©ma DB
4. Adapter controllers
5. Adapter frontend
6. Tests complets
7. Documentation
```

---

## ğŸ“‚ STRUCTURE Ã€ RESPECTER

### Projet

```
projects/<nom>/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ controllers/    â† Logique mÃ©tier
â”‚   â”œâ”€â”€ routes/         â† DÃ©finition routes
â”‚   â”œâ”€â”€ middleware/     â† Middlewares
â”‚   â”œâ”€â”€ utils/          â† Utilitaires
â”‚   â””â”€â”€ server.js       â† Point d'entrÃ©e
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/app/        â† Pages Next.js
â”‚   â””â”€â”€ src/lib/        â† Utilitaires client
â”œâ”€â”€ database/
â”‚   â””â”€â”€ schema.sql      â† SchÃ©ma spÃ©cifique
â””â”€â”€ README.md
```

### Core (NE PAS MODIFIER SANS VALIDATION)

```
core/
â”œâ”€â”€ auth/authService.js           â† Auth multi-tenant
â”œâ”€â”€ middleware/authMiddleware.js  â† Middlewares partagÃ©s
â”œâ”€â”€ database/supabaseClient.js    â† Client DB
â””â”€â”€ shared-utils/                 â† Utilitaires communs
```

---

## ğŸ†˜ EN CAS DE DOUTE

1. **Relire** AI_AGENT_GUIDE.md
2. **VÃ©rifier** docs/ESSENTIELS/RULES_REFERENCE.md
3. **Demander** clarification Ã  l'utilisateur
4. **Ne pas** faire de suppositions
5. **Proposer** un plan avant d'exÃ©cuter

---

## ğŸ“Š INFORMATIONS TECHNIQUES

### Ports

| Service | Port |
|---------|------|
| Backend Central | 4000 |
| Hearst Qatar | 3001 |
| Hearst Design | 3002 |
| Hearst SRQ | 3003 |

### Technologies

- **Backend** : Node.js 18+, Express.js, Supabase
- **Frontend** : Next.js 14, React 18, TypeScript, Tailwind
- **Auth** : JWT + bcrypt
- **DB** : PostgreSQL (via Supabase)

### RÃ´les Utilisateurs

1. `super_admin` - AccÃ¨s global plateforme
2. `admin` - Admin d'un tenant
3. `manager` - Gestion opÃ©rationnelle
4. `operator` - OpÃ©rations quotidiennes
5. `viewer` - Lecture seule

---

## âœ¨ RAPPEL FINAL

> **"Hearst Control = Autonomie + Isolation + RÃ©utilisabilitÃ©"**

- **Autonomie** : Le systÃ¨me se configure, vÃ©rifie, rÃ©pare, lance tout seul
- **Isolation** : Chaque projet/tenant est 100% indÃ©pendant
- **RÃ©utilisabilitÃ©** : 70-80% du code est rÃ©utilisable

**En cas de doute, demander. Mieux vaut une question qu'une erreur.**

---

Hearst Control V2.0 | .cursorrules | DÃ©cembre 2025

