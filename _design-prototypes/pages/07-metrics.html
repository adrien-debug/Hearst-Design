<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics - Hearst Design</title>
    <link rel="stylesheet" href="../assets/css/design-system.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .period-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
        }

        .period-tab {
            padding: var(--space-2) var(--space-4);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            border: var(--border-thin) solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .period-tab.active {
            background: var(--primary-green);
            color: #000000;
            border-color: var(--primary-green);
        }

        .period-tab:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
        }

        .refresh-status {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .refresh-countdown {
            font-weight: var(--font-semibold);
            color: var(--primary-green);
        }

        .current-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-8);
        }

        .chart-container {
            background: var(--primary-grey);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .chart-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-4);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .export-btn {
            padding: var(--space-2) var(--space-4);
            font-size: var(--text-sm);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <div class="logo">
                <img src="../assets/images/hearst-logo.svg" alt="HEARST" style="width: 120px;">
            </div>
        </div>

        <nav class="nav-menu">
            <a href="02-dashboard.html" class="nav-item" data-page="dashboard">
                üè† Dashboard
            </a>
            <a href="03-containers-list.html" class="nav-item" data-page="containers">
                üì¶ Containers <span style="opacity: 0.5;">(20)</span>
            </a>
            <a href="05-miners-list.html" class="nav-item" data-page="miners">
                ‚ö° Miners <span style="opacity: 0.5;">(6,160)</span>
            </a>
            <a href="07-metrics.html" class="nav-item active" data-page="metrics">
                üìä Metrics
            </a>
            <a href="#alerts" class="nav-item" data-page="alerts">
                üîî Alerts
            </a>
        </nav>

        <div class="sidebar-footer">
            <div style="font-size: 11px; color: var(--text-muted);">
                v1.0.0 ‚Ä¢ Hearst Design
            </div>
        </div>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="header-title">
            Metrics
        </div>
        <div class="header-actions">
            <div class="user-menu">
                <div class="user-info">
                    <div class="user-name" id="userName">Admin Design</div>
                    <div class="user-role" id="userRole">Administrator</div>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 16px;">
                    üë§ Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Metrics Header -->
        <div class="metrics-header">
            <div class="period-tabs">
                <button class="period-tab" data-period="1h">1h</button>
                <button class="period-tab" data-period="6h">6h</button>
                <button class="period-tab active" data-period="24h">24h</button>
                <button class="period-tab" data-period="7d">7d</button>
            </div>

            <div class="refresh-status">
                <span class="refresh-countdown" id="countdown">10s</span>
                <span>Auto-refresh üîÑ</span>
                <button class="btn btn-secondary export-btn" onclick="exportData()">
                    üì• Export CSV
                </button>
            </div>
        </div>

        <!-- Current Stats -->
        <div class="current-stats" id="currentStats">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Charts -->
        <div class="chart-container">
            <div class="chart-title">üìà Hashrate History (24h)</div>
            <div class="chart-wrapper">
                <canvas id="hashrateChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">‚ö° Power Consumption (24h)</div>
            <div class="chart-wrapper">
                <canvas id="powerChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">üå°Ô∏è Temperature Distribution</div>
            <div class="chart-wrapper">
                <canvas id="tempChart"></canvas>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../assets/js/api-mock.js"></script>
    <script src="../assets/js/navigation.js"></script>
    <script src="../assets/js/components.js"></script>
    
    <script>
        // Check authentication
        const token = localStorage.getItem('hearst_token');
        const user = localStorage.getItem('hearst_user');
        
        if (!token || !user) {
            window.location.href = '01-login.html';
        }

        // Load user info
        const userData = JSON.parse(user);
        document.getElementById('userName').textContent = userData.name;
        document.getElementById('userRole').textContent = userData.role.toUpperCase();

        // Logout function
        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                localStorage.removeItem('hearst_token');
                localStorage.removeItem('hearst_user');
                window.location.href = '01-login.html';
            }
        }

        // Chart instances
        let hashrateChart, powerChart, tempChart;

        // Auto-refresh countdown
        let countdown = 10;
        let countdownInterval;

        function startCountdown() {
            countdown = 10;
            document.getElementById('countdown').textContent = `${countdown}s`;
            
            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = `${countdown}s`;
                
                if (countdown <= 0) {
                    loadMetrics();
                    countdown = 10;
                }
            }, 1000);
        }

        // Load current metrics
        async function loadCurrentMetrics() {
            const container = document.getElementById('currentStats');
            const { createStatCard, formatNumber } = HearstComponents;
            
            try {
                const metrics = await HearstAPI.getMetrics();
                
                const stats = [
                    {
                        icon: 'üöÄ',
                        title: 'Hashrate',
                        value: `${metrics.total_hashrate_ehs} EH/s`,
                        label: `${formatNumber(metrics.total_hashrate_ths)} TH/s`
                    },
                    {
                        icon: '‚ö°',
                        title: 'Power',
                        value: `${metrics.total_power_mw} MW`,
                        label: `${formatNumber(metrics.total_power_kw)} kW`
                    },
                    {
                        icon: 'üå°Ô∏è',
                        title: 'Temperature',
                        value: `${metrics.average_temperature}¬∞C`,
                        label: 'Average'
                    },
                    {
                        icon: '‚úÖ',
                        title: 'Uptime',
                        value: `${metrics.uptime_percentage}%`,
                        label: 'System uptime'
                    }
                ];
                
                container.innerHTML = stats.map(stat => createStatCard(stat)).join('');
                
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Load hashrate history
        async function loadHashrateChart() {
            try {
                const history = await HearstAPI.getHashrateHistory();
                
                const ctx = document.getElementById('hashrateChart');
                
                if (hashrateChart) {
                    hashrateChart.destroy();
                }
                
                hashrateChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(h => new Date(h.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })),
                        datasets: [{
                            label: 'Hashrate (TH/s)',
                            data: history.map(h => h.hashrate_ths),
                            borderColor: '#8afd81',
                            backgroundColor: 'rgba(138, 253, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#999999' },
                                grid: { color: '#2a2a2a' }
                            },
                            x: {
                                ticks: { color: '#999999' },
                                grid: { color: '#2a2a2a' }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading hashrate chart:', error);
            }
        }

        // Load power chart
        async function loadPowerChart() {
            try {
                const history = await HearstAPI.getPowerHistory();
                
                const ctx = document.getElementById('powerChart');
                
                if (powerChart) {
                    powerChart.destroy();
                }
                
                powerChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(h => new Date(h.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })),
                        datasets: [{
                            label: 'Power (kW)',
                            data: history.map(h => h.power_kw),
                            borderColor: '#f6c344',
                            backgroundColor: 'rgba(246, 195, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#999999' },
                                grid: { color: '#2a2a2a' }
                            },
                            x: {
                                ticks: { color: '#999999' },
                                grid: { color: '#2a2a2a' }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading power chart:', error);
            }
        }

        // Load temperature chart (gauge simulation with doughnut)
        async function loadTempChart() {
            try {
                const metrics = await HearstAPI.getMetrics();
                
                const ctx = document.getElementById('tempChart');
                
                if (tempChart) {
                    tempChart.destroy();
                }
                
                tempChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Current', 'Remaining'],
                        datasets: [{
                            data: [metrics.average_temperature, 100 - metrics.average_temperature],
                            backgroundColor: ['#8afd81', '#1a1a1a'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading temp chart:', error);
            }
        }

        // Load all metrics
        async function loadMetrics() {
            await loadCurrentMetrics();
            await loadHashrateChart();
            await loadPowerChart();
            await loadTempChart();
        }

        // Export data
        function exportData() {
            HearstComponents.showToast('CSV export will be available soon', 'info');
        }

        // Period tab handler
        document.querySelectorAll('.period-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                loadMetrics();
            });
        });

        // Initialize
        HearstNav.init();
        loadMetrics();
        startCountdown();

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            if (hashrateChart) hashrateChart.destroy();
            if (powerChart) powerChart.destroy();
            if (tempChart) tempChart.destroy();
        });
    </script>
</body>
</html>

