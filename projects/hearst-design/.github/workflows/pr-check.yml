name: ğŸ” PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # PR Size Check
  # ============================================
  pr-size:
    name: ğŸ“ Check PR Size
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“Š Analyze PR Size
        run: |
          files_changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          lines_changed=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')
          
          echo "ğŸ“ Files changed: $files_changed"
          echo "ğŸ“ Lines changed: $lines_changed"
          
          if [ $files_changed -gt 50 ]; then
            echo "âš ï¸ Warning: Large PR ($files_changed files)"
            echo "Consider splitting into smaller PRs"
          fi
          
          if [ $lines_changed -gt 1000 ]; then
            echo "âš ï¸ Warning: Large PR ($lines_changed lines)"
            echo "Consider splitting into smaller PRs"
          fi
  
  # ============================================
  # PR Title Check
  # ============================================
  pr-title:
    name: ğŸ“ Check PR Title
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            test
            chore
          requireScope: false
  
  # ============================================
  # Code Review Checklist
  # ============================================
  checklist:
    name: âœ… Review Checklist
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Post Checklist Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `
            ## ğŸ“‹ PR Review Checklist
            
            Merci pour votre contribution ! Veuillez vÃ©rifier :
            
            ### Code Quality
            - [ ] Le code suit les conventions du projet
            - [ ] Pas de code commentÃ© ou de console.log
            - [ ] Variables et fonctions bien nommÃ©es
            - [ ] Pas de duplication de code
            
            ### Tests
            - [ ] Tests unitaires ajoutÃ©s/mis Ã  jour
            - [ ] Tests passent localement
            - [ ] Coverage maintenu ou amÃ©liorÃ©
            
            ### Documentation
            - [ ] README mis Ã  jour si nÃ©cessaire
            - [ ] Commentaires ajoutÃ©s pour code complexe
            - [ ] API docs mises Ã  jour
            
            ### Security
            - [ ] Pas de secrets hardcodÃ©s
            - [ ] Validation des entrÃ©es utilisateur
            - [ ] Gestion appropriÃ©e des erreurs
            
            ### Performance
            - [ ] Pas de requÃªtes N+1
            - [ ] Images optimisÃ©es
            - [ ] Pas de boucles inutiles
            
            ---
            
            *Cette checklist est gÃ©nÃ©rÃ©e automatiquement. Cochez les items au fur et Ã  mesure.*
            `;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Review Checklist')
            );
            
            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
  
  # ============================================
  # Dependency Review
  # ============================================
  dependency-review:
    name: ğŸ” Dependency Review
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Review Dependencies
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

